<!DOCTYPE html>
<html>
<head>
    <title>Plots XY - Science Lab</title>
    <meta name="description" content="Plots XY ofrece gráficos interactivos y herramientas de visualización para análisis de datos. Ideal para prácticas de ciencias en Secundaria y primeros años universitarios.">
    <meta name="google-site-verification" content="1psBQTzJBgx9fHWgpllgWjbrcEWHsjlsgn5J0C7KF_4" />
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<h1>Plots XY</h1>
<h2>Sience Lab</h2>
<div style="text-align: right;">
    <button type="button" class="btn btn-primary" onclick="window.location.href='index.html'">ES</button>
  </div>
<h3>How it works?</h3>
<p>Please enter the x and y data into the table by pressing "Enter" to generate more rows. When finished, click the "Confirm Data" button to verify and plot the entered data. You can then download it as a "data.txt" file.</p>
<p>[Important] Currently, the application only supports positive (x,y) inputs and linear regression, which will be useful for sketching graphs in most Science laboratory experiments. </p>
<form id="dataForm">
    <div id="tableContainer">
    <table>
        <thead>
            <tr>
                <th>Data X</th>
                <th>Data Y</th>
            </tr>
        </thead>
        <tbody id="dataInputs"></tbody>
    </table>
    </div>
    <div>
      <button type="button" id="botonEliminar" onclick="eliminarFila()" class="btn btn-primary" style="display: none;">Delete Row</button>
    </div>
  <button type="submit" id="submitButton" class="btn btn-primary">Confirm Data</button>
</form>
    
<div class="mt-4">
    <p id="successMessage" style="display: none;">Points entered successfully! Please verify that the data is correct.</p>
    <table id="successTable" class="table table-bordered" style="display: none;"></table>
</div>
<div class="container">
<canvas id="chartCanvas" width="360" height="360"></canvas>
</div>
<button type="button" id="lineButton" onclick="plotLine()" class="btn btn-primary" style="display: none;">Trend Line</button>
<p></p>
<p id ='linealFunction' style = "display: none;">linealFunctionText</p>

<p id="descarga_parrafo" style="display: none;">If desired, click the "Download Data" button to save the "data.txt" file.</p>
<button type="button" id="downloadButton" onclick="downloadData()" class="btn btn-primary" style="display: none;">Download Data</button>
<button onclick="location.reload();" class="btn btn-primary">Reset</button>
<p></p>
<p class='centered'>(c)2023 - Prof. Pablo Vaz</p>
<a href="https://fisicamaldonado.wordpress.com" target="_blank"><p class='centered'>fisicamaldonado.wordpress.com</p></a>
<p class='centered'>Maldonado - Uruguay</p>    
<script>
var isGraphGenerated = false;
var successTable = document.getElementById('successTable');
var chartCanvas = document.getElementById('chartCanvas');
var ctx = chartCanvas.getContext('2d');
var points = [];
createDataRow(1);// Create 1 Row when the App starts

// Generate the verification table and disable "Confirma Data" Button
document.getElementById('dataForm').addEventListener('submit', function(event) {
    event.preventDefault();
    if (isGraphGenerated) return;

    isGraphGenerated = true;
    document.getElementById('submitButton').disabled = true;
    document.getElementById('successMessage').style.display = 'block';
    document.getElementById("descarga_parrafo").style.display = "block";
    showSuccessTable();
    document.getElementById('downloadButton').style.display = 'inline-block';
});

// New Rows when "Enter" is pressed
document.getElementById('dataForm').addEventListener('keydown', function(event) {
    if (isGraphGenerated || event.key !== 'Enter') return;

    event.preventDefault();
    var numPoints = document.getElementById('dataInputs').getElementsByTagName('tr').length;
    createDataRow(numPoints + 1);
    toggleBotonEliminar();
});

//The "Delete Row" button is shown only when Rows > 1
function toggleBotonEliminar() {
  var numFilas = document.getElementById('dataInputs').getElementsByTagName('tr').length;
  var botonEliminar = document.getElementById('botonEliminar');

  if (numFilas > 1) {
    botonEliminar.style.display = 'block';
  } else {
    botonEliminar.style.display = 'none';
  }
}

function eliminarFila() {
  var table = document.getElementById('dataInputs');
  var numRows = table.rows.length;
  
  if (numRows > 1) {
    table.deleteRow(numRows - 1);
    toggleBotonEliminar();
  }
}

//Create Rows
function createDataRow(rowNum) {
    var tableBody = document.getElementById('dataInputs');
    var row = document.createElement('tr');
    var cellX = document.createElement('td');
    var inputX = document.createElement('input');
    inputX.type = 'number';
    inputX.name = 'x' + rowNum;
    inputX.step = 'any'; // Allow decimal values
    inputX.required = true;
    cellX.appendChild(inputX);

    var cellY = document.createElement('td');
    var inputY = document.createElement('input');
    inputY.type = 'number';
    inputY.name = 'y' + rowNum;
    inputY.step = 'any';
    inputY.required = true;
    cellY.appendChild(inputY);

    row.appendChild(cellX);
    row.appendChild(cellY);

    tableBody.appendChild(row);
}
        
function showSuccessTable() {
    var xValues = [];
    var yValues = [];
    points = [];

    var rows = document.getElementById('dataInputs').getElementsByTagName('tr');
    var tableBody = successTable.createTBody();

    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var xValue = row.cells[0].querySelector('input').value;
        var yValue = row.cells[1].querySelector('input').value;
        xValues.push(xValue);
        yValues.push(yValue);

        var newRow = tableBody.insertRow(i);
        newRow.insertCell(0).textContent = xValue;
        newRow.insertCell(1).textContent = yValue;

        points.push({ x: parseFloat(xValue), y: parseFloat(yValue) });
        document.getElementById('lineButton').style.display = 'block';

    }

    drawChart();

    successTable.style.display = 'table';
    }
 // Download TXT file
function downloadData() {
  var xValues = [];
  var yValues = [];

  var rows = document.getElementById('dataInputs').getElementsByTagName('tr');

  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var xValue = row.cells[0].querySelector('input').value;
    var yValue = row.cells[1].querySelector('input').value;
    xValues.push(xValue);
    yValues.push(yValue);
  }

  var data = "X Values\tY Values\n";

  for (var j = 0; j < xValues.length; j++) {
    data += xValues[j] + "\t" + yValues[j] + "\n";
  }

  var blob = new Blob([data], { type: 'text/plain' });
  var url = URL.createObjectURL(blob);

  var link = document.createElement('a');
  link.href = url;
  link.download = 'data.txt';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Plot the Chart and the Data points
function drawChart() {
    console.log(points);
    ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
    var maxX = Math.max(...points.map(point => point.x));
    var maxY = Math.max(...points.map(point => point.y));

    // Margin
    var margin = 40;

    ctx.beginPath();
    ctx.moveTo(margin, chartCanvas.height - margin);
    ctx.lineTo(margin, margin);
    ctx.moveTo(margin, chartCanvas.height - margin);
    ctx.lineTo(chartCanvas.width - margin, chartCanvas.height - margin);
    ctx.stroke();

    // Plot the points
    for (var j = 0; j < points.length; j++) {
        var xCoord = margin + (points[j].x / maxX) * (chartCanvas.width - margin * 2);
        var yCoord = chartCanvas.height - margin - (points[j].y / maxY) * (chartCanvas.height - margin * 2);

        ctx.beginPath();
        ctx.arc(xCoord, yCoord, 3, 0, 2 * Math.PI);
        ctx.fillStyle = 'red';
        ctx.fill();
        ctx.stroke();
    }
  
    // Add the XY Axis
    ctx.font = '12px Arial';
    ctx.textAlign = 'end';
    ctx.fillText('0', margin - 5, chartCanvas.height - margin + 15);
    ctx.fillText('x_max: ' + maxX, chartCanvas.width - margin, chartCanvas.height - margin + 15);
    ctx.textAlign = 'start';
    ctx.fillText('y_max: ' + maxY, margin, margin - 5);
}
function plotLine() {
  var maxX = Math.max(...points.map(point => point.x));
  var maxY = Math.max(...points.map(point => point.y));

  // Margin
  var margin = 36;
  if (points.length >= 2) {
    // Trend line coeficients
    var x = points.map(point => point.x);//Extrae las coordenadas de cada punto en el array 'points' y las almacena en los arrays x e y, respectivamente.
    var y = points.map(point => point.y);
    var sumX = x.reduce((a, b) => a + b, 0);//Calcula la suma de todos los valores en x y y.
    var sumY = y.reduce((a, b) => a + b, 0);
    var sumXY = x.map((value, index) => value * y[index]).reduce((a, b) => a + b, 0);//Calcula la suma de los productos de cada elemento en x y su correspondiente elemento en y.
    var sumXSquared = x.map(value => value * value).reduce((a, b) => a + b, 0);//Calcula la suma de los cuadrados de los valores en x.
    var numPoints = points.length;//Determina el número de puntos disponibles

    var m = (numPoints * sumXY - sumX * sumY) / (numPoints * sumXSquared - sumX * sumX);
    var n = (sumY - m * sumX) / numPoints;

    m = parseFloat(m.toFixed(3));
    n = parseFloat(n.toFixed(3));

    var chartWidth = chartCanvas.width - margin * 2;
    var chartHeight = chartCanvas.height - margin * 2;

    // Calculate the Trend line coordinates for the start and end
    var xStart = margin;
    var yStart = chartCanvas.height - margin - (n / maxY) * chartHeight;
    var xEnd = margin + chartWidth;
    var yEnd = chartCanvas.height - margin - ((m * maxX + n) / maxY) * chartHeight;

    // Plot the Trend line
    ctx.beginPath();
    ctx.moveTo(xStart, yStart);
    ctx.lineTo(xEnd, yEnd);
    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Show the linear function
    var linealFunctionText = "The linear function is: y = " + m + "x + " + n;
    var linealFunctionElement = document.getElementById("linealFunction");
    linealFunctionElement.textContent = linealFunctionText;
    linealFunctionElement.style.display = "block";
  }
}
</script>
</body>
</html>
